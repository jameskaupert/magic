---
- hosts: localhost
  become: yes
  gather_facts: yes
  
  tasks:
    - name: Update system
      pacman:
        update_cache: yes
        upgrade: yes

    - name: Install essential packages
      pacman:
        name:
          - base-devel
          - git
          - github-cli
          - curl
          - wget
          - bind
          - unzip
          - eza
          - fzf
          - fd
          - ripgrep
          - bat
          - dust
          - duf
          - git-delta
          - jq
          - zsh
          - zsh-completions
          - docker
          - docker-compose
          - ansible
          - mise
          - noto-fonts-emoji
          - ttf-dejavu
          - ttf-font-awesome
          - otf-overpass-nerd
          - ttf-jetbrains-mono-nerd
          - ttf-iosevka-nerd
          - ttf-cascadia-code-nerd
        state: present

    - name: Install Hyprland ecosystem
      pacman:
        name:
          - hyprland
          - waybar
          - rofi
          - mako
          - hyprlock
          - hypridle
          - grim
          - slurp
          - wl-clipboard
          - rio
        state: present

    - name: Install GUI applications
      pacman:
        name:
          - discord
          - firefox-developer-edition
          - chromium
          - vlc
          - gimp
        state: present

    - name: Configure display and session management
      include_tasks: tasks/display.yml

    - name: Configure Docker
      include_tasks: tasks/docker.yml

    - name: Configure browser policies
      include_tasks: tasks/browser-policies.yml

    - name: Ensure docker group exists
      group:
        name: docker
        state: present

    - name: Add user to docker group
      user:
        name: "{{ target_user }}"
        groups: docker
        append: yes

    - name: Force add user to docker group with usermod
      command: usermod -aG docker {{ target_user }}
      changed_when: false

    - name: Verify greetd service is active
      systemd:
        name: greetd
      register: greetd_status

    - name: Verify docker service is active
      systemd:
        name: docker
      register: docker_status

    - name: Show service status
      debug:
        msg: "Services - greetd: {{ greetd_status.status.ActiveState }}, docker: {{ docker_status.status.ActiveState }}"

  handlers:
    - name: restart greetd
      systemd:
        name: greetd
        state: restarted
        
    - name: restart docker
      systemd:
        name: docker
        state: restarted
